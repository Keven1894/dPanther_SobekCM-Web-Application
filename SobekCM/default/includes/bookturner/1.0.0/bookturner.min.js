function GnuBook(){this.reduce=4;this.padding=10;this.mode=2;this.ui="full";this.displayedIndices=[];this.imgs={};this.prefetchedImgs={};this.timer=null;this.animating=!1;this.auto=!1;this.autoTimer=null;this.flipSpeed="fast";this.twoPagePopUp=null;this.leafEdgeTmp=null;this.embedPopup=null;this.searchResults={};this.firstIndex=null;this.lastDisplayableIndex2up=null;this.logoURL="http://www.ufl.edu";this.imagesBaseURL="/BookSource/images/";this.constMode1up=1;this.constMode2up=2;this.reductionFactors=[.5,.75,1,1.5,2,4,8,16];this.twoPage={coverInternalPadding:10,coverExternalPadding:2,bookSpineDivWidth:20,autofit:!0}}GnuBook.prototype.init=function(){var n=undefined,t=this.paramsFromFragment(window.location.hash);"undefined"!=typeof t.index?n=t.index:"undefined"!=typeof t.page&&(n=this.getPageIndex(t.page));"undefined"==typeof n&&"undefined"!=typeof this.titleLeaf&&(n=this.leafNumToIndex(this.titleLeaf));"undefined"==typeof n&&(n=0);"undefined"!=typeof t.mode&&(this.mode=t.mode);this.canSwitchToMode(this.mode)||(this.mode=this.constMode1up);$("#GnuBook").empty();this.initToolbar(this.mode,this.ui);$("#GnuBook").append("<div id='GBcontainer'><\/div>");$("#GBcontainer").append("<div id='GBpageview'><\/div>");$("#GBcontainer").bind("scroll",this,function(n){n.data.loadLeafs()});this.setupKeyListeners();this.startLocationPolling();$(window).bind("resize",this,function(n){if(1==n.data.mode)n.data.centerPageView(),$("#GBpageview").empty(),n.data.displayedIndices=[],n.data.updateSearchHilites(),n.data.loadLeafs();else if(n.data.twoPage.autofit)n.data.prepareTwoPageView();else{var t=n.data.twoPageGetViewCenter(),i=!1;n.data.twoPage.totalWidth<$("#GBcontainer").attr("clientWidth")&&(t.percentageX=.5,i=!0);n.data.twoPage.totalHeight<$("#GBcontainer").attr("clientHeight")&&(t.percentageY=.5,i=!0);i&&n.data.twoPageCenterView(t.percentageX,t.percentageY)}});$(".GBpagediv1up").bind("mousedown",this,function(){});1==this.mode?(this.resizePageView(),this.firstIndex=n,this.jumpToIndex(n)):(this.displayedIndices=[0],this.firstIndex=n,this.displayedIndices=[this.firstIndex],this.prepareTwoPageView());this.updateFromParams(t)};GnuBook.prototype.setupKeyListeners=function(){var n=this,t=33,i=34,r=35,u=36,f=37,e=38,o=39,s=40;$(document).keydown(function(h){switch(h.keyCode){case t:case e:2==n.mode&&(h.preventDefault(),n.prev());break;case s:case i:2==n.mode&&(h.preventDefault(),n.next());break;case r:h.preventDefault();n.last();break;case u:h.preventDefault();n.first();break;case f:if(n.keyboardNavigationIsDisabled(h)){h.preventDefault();break}2==n.mode&&(h.preventDefault(),n.left());break;case o:if(n.keyboardNavigationIsDisabled(h)){h.preventDefault();break}2==n.mode&&(h.preventDefault(),n.right())}})};GnuBook.prototype.drawLeafs=function(){1==this.mode?this.drawLeafsOnePage():this.drawLeafsTwoPage()};GnuBook.prototype.setDragHandler=function(n){n.dragging=!1;$(n).unbind("mousedown").bind("mousedown",function(n){n.preventDefault();this.dragging=!0;this.prevMouseX=n.pageX;this.prevMouseY=n.pageY;var t=n.pageX,i=n.pageY,r=$("#GBcontainer").attr("scrollTop"),u=$("#GBcontainer").attr("scrollLeft")});$(n).unbind("mousemove").bind("mousemove",function(n){n.preventDefault();var t=n.pageX-this.prevMouseX,i=n.pageY-this.prevMouseY;this.dragging&&($("#GBcontainer").attr("scrollTop",$("#GBcontainer").attr("scrollTop")-i),$("#GBcontainer").attr("scrollLeft",$("#GBcontainer").attr("scrollLeft")-t));this.prevMouseX=n.pageX;this.prevMouseY=n.pageY});$(n).unbind("mouseup").bind("mouseup",function(n){n.preventDefault();this.dragging=!1});$(n).unbind("mouseleave").bind("mouseleave",function(n){n.preventDefault();this.dragging=!1});$(n).unbind("mouseenter").bind("mouseenter",function(n){n.preventDefault();this.dragging=!1})};GnuBook.prototype.setDragHandler2UP=function(n){n.dragging=!1;$(n).unbind("mousedown").bind("mousedown",function(n){n.preventDefault();this.dragStart={x:n.pageX,y:n.pageY};this.mouseDown=!0;this.dragging=!1;this.prevMouseX=n.pageX;this.prevMouseY=n.pageY;var t=n.pageX,i=n.pageY,r=$("#GBcontainer").attr("scrollTop"),u=$("#GBcontainer").attr("scrollLeft")});$(n).unbind("mousemove").bind("mousemove",function(n){n.preventDefault();var t=n.pageX-this.prevMouseX,i=n.pageY-this.prevMouseY,r=Math.max(Math.abs(t),Math.abs(i));this.mouseDown&&r>5&&(this.dragging=!0);this.dragging&&($("#GBcontainer").attr("scrollTop",$("#GBcontainer").attr("scrollTop")-i),$("#GBcontainer").attr("scrollLeft",$("#GBcontainer").attr("scrollLeft")-t),this.prevMouseX=n.pageX,this.prevMouseY=n.pageY)});$(n).unbind("mouseleave").bind("mouseleave",function(n){n.preventDefault();this.dragging=!1;this.mouseDown=!1});$(n).unbind("mouseenter").bind("mouseenter",function(n){n.preventDefault();this.dragging=!1;this.mouseDown=!1})};GnuBook.prototype.setClickHandler2UP=function(n,t,i){$(n).unbind("click").bind("click",t,function(n){n.preventDefault();this.mouseDown&&!this.dragging&&i(n);this.dragging=!1;this.mouseDown=!1})};GnuBook.prototype.drawLeafsOnePage=function(){var f,v,n,y,u,c,i,l,s,e;this.timer=null;for(var h=$("#GBcontainer").attr("scrollTop"),a=h+$("#GBcontainer").height(),t=[],r=0,o=0,n=0;n<this.numLeafs;n++){u=parseInt(this.getPageHeight(n)/this.reduce);o+=u;var p=r>=h&&r<=a,w=o>=h&&o<=a,b=r<=h&&o>=a;p|w|b&&t.push(n);r+=u+10;o+=10}for(f=t[0],this.firstIndex=f,this.displayedIndices.length>0&&this.updateLocationHash(),0!=f&&1<this.reduce&&(f--,t.unshift(f)),v=t[t.length-1],this.numLeafs-1!=v&&1<this.reduce&&t.push(v+1),r=0,n=0;n<f;n++)r+=parseInt(this.getPageHeight(n)/this.reduce)+10;for(y=$("#GBcontainer").attr("scrollWidth"),n=0;n<t.length;n++)e=t[n],u=parseInt(this.getPageHeight(e)/this.reduce),-1==jQuery.inArray(t[n],this.displayedIndices)&&(c=parseInt(this.getPageWidth(e)/this.reduce),i=document.createElement("div"),i.className="GBpagediv1up",i.id="pagediv"+e,i.style.position="absolute",$(i).css("top",r+"px"),l=y-c>>1,l<0&&(l=0),$(i).css("left",l+"px"),$(i).css("width",c+"px"),$(i).css("height",u+"px"),this.setDragHandler(i),$("#GBpageview").append(i),s=document.createElement("img"),s.src=this.getPageURI(e),$(s).css("width",c+"px"),$(s).css("height",u+"px"),$(i).append(s)),r+=u+10;for(n=0;n<this.displayedIndices.length;n++)-1==jQuery.inArray(this.displayedIndices[n],t)&&(e=this.displayedIndices[n],$("#pagediv"+e).remove());this.displayedIndices=t.slice();this.updateSearchHilites();null!=this.getPageNum(f)?$("#GBpagenum").val(this.getPageNum(this.currentIndex())):$("#GBpagenum").val("");this.updateToolbarZoom(this.reduce)};GnuBook.prototype.drawLeafsTwoPage=function(){var r=$("#GBtwopageview").attr("scrollTop"),f=r+$("#GBtwopageview").height(),n=this.twoPage.currentIndexL,e=this.getPageHeight(n),o=this.getPageWidth(n),u=this.leafEdgeWidth(n),s=this.twoPage.edgeWidth-u,h=this.twoPage.bookCoverDivWidth,c=this.twoPage.middle,i=this.twoPageTop(),l=this.twoPage.bookCoverDivLeft;this.twoPage.scaledWL=this.getPageWidth2UP(n);this.twoPage.gutter=this.twoPageGutter();this.prefetchImg(n);$(this.prefetchedImgs[n]).css({position:"absolute",left:this.twoPage.gutter-this.twoPage.scaledWL+"px",right:"",top:i+"px",backgroundColor:"rgb(234, 226, 205)",height:this.twoPage.height+"px",width:this.twoPage.scaledWL+"px",borderRight:"0px solid black",zIndex:2}).appendTo("#GBtwopageview");var t=this.twoPage.currentIndexR,a=this.getPageHeight(t),v=this.getPageWidth(t);this.twoPage.scaledWR=this.getPageWidth2UP(t);this.prefetchImg(t);$(this.prefetchedImgs[t]).css({position:"absolute",left:this.twoPage.gutter+"px",right:"",top:i+"px",backgroundColor:"rgb(234, 226, 205)",height:this.twoPage.height+"px",width:this.twoPage.scaledWR+"px",borderLeft:"0px solid black",zIndex:2}).appendTo("#GBtwopageview");this.displayedIndices=[this.twoPage.currentIndexL,this.twoPage.currentIndexR];this.setMouseHandlers2UP();this.twoPageSetCursor();this.updatePageNumBox2UP();this.updateToolbarZoom(this.reduce)};GnuBook.prototype.updatePageNumBox2UP=function(){null!=this.getPageNum(this.twoPage.currentIndexL)?$("#GBpagenum").val(this.getPageNum(this.twoPage.currentIndexL)):$("#GBpagenum").val("");this.updateLocationHash()};GnuBook.prototype.loadLeafs=function(){var n=this;null==this.timer?this.timer=setTimeout(function(){n.drawLeafs()},250):(clearTimeout(this.timer),this.timer=setTimeout(function(){n.drawLeafs()},250))};GnuBook.prototype.zoom=function(n){switch(this.mode){case this.constMode1up:return this.zoom1up(n);case this.constMode2up:return this.zoom2up(n)}};GnuBook.prototype.zoom1up=function(n){if(2==this.mode){this.switchMode(1);return}if(1==n){if(this.reduce<=.5)return;this.reduce*=.5}else{if(this.reduce>=8)return;this.reduce*=2}this.resizePageView();$("#GBpageview").empty();this.displayedIndices=[];this.loadLeafs();this.updateToolbarZoom(this.reduce)};GnuBook.prototype.resizePageView=function(){for(var r=0,t=$("#GBcontainer").attr("clientWidth"),v=$("#GBcontainer").attr("scrollTop"),y=$("#GBcontainer").attr("scrollLeft"),f=$("#GBpageview").height(),c=$("#GBpageview").width(),l=this.centerY1up(),a=this.centerX1up(),u,o,s,h,i,e=0!=f?l/f:0,n=0;n<this.numLeafs;n++)r+=parseInt(this.getPageHeight(n)/this.reduce)+this.padding,u=parseInt(this.getPageWidth(n)/this.reduce),u>t&&(t=u);$("#GBpageview").height(r);$("#GBpageview").width(t);o=e*r;s=Math.max(0,Math.floor(o-$("#GBcontainer").height()/2));$("#GBcontainer").attr("scrollTop",s);h=a*(t/c);i=h-$("#GBcontainer").attr("clientWidth")/2;i=Math.max(i,0);$("#GBcontainer").attr("scrollLeft",i);this.loadLeafs()};GnuBook.prototype.centerX1up=function(){var n;return n=$("#GBpageview").width()<$("#GBcontainer").attr("clientWidth")?$("#GBpageview").width():$("#GBcontainer").attr("scrollLeft")+$("#GBcontainer").attr("clientWidth")/2,Math.floor(n)};GnuBook.prototype.centerY1up=function(){var n=$("#GBcontainer").attr("scrollTop")+$("#GBcontainer").height()/2;return Math.floor(n)};GnuBook.prototype.centerPageView=function(){var n=$("#GBcontainer").attr("scrollWidth"),t=$("#GBcontainer").attr("clientWidth");n>t&&$("#GBcontainer").attr("scrollLeft",(n-t)/2)};GnuBook.prototype.zoom2up=function(n){var t,i,r;if(this.stopFlipAnimations(),t=this.twoPageNextReduce(this.reduce,n),this.reduce!=t.reduce||this.twoPage.autofit!=t.autofit){if(this.twoPage.autofit=t.autofit,this.reduce=t.reduce,i=this.twoPageGetViewCenter(),1==n)for(r in this.prefetchedImgs)delete this.prefetchedImgs[r];this.prepareTwoPageView(i.percentageX,i.percentageY)}};GnuBook.prototype.quantizeReduce=function(n){for(var i=this.reductionFactors[0],r=Math.abs(n-i),t=1;t<this.reductionFactors.length;t++)newDistance=Math.abs(n-this.reductionFactors[t]),newDistance<r&&(r=newDistance,i=this.reductionFactors[t]);return i};GnuBook.prototype.twoPageNextReduce=function(n,t){var i={},f=this.twoPageGetAutofitReduce(),e,u,r;if(0==t)i.autofit=!0,i.reduce=f;else if(1==t){for(u=this.reductionFactors[0],r=1;r<this.reductionFactors.length;r++)this.reductionFactors[r]<n&&(u=this.reductionFactors[r]);!this.twoPage.autofit&&f<n&&f>u?(i.autofit=!0,i.reduce=f):(i.autofit=!1,i.reduce=u)}else{for(e=this.reductionFactors.length-1,u=this.reductionFactors[e],r=e;r>=0;r--)this.reductionFactors[r]>n&&(u=this.reductionFactors[r]);!this.twoPage.autofit&&f>n&&f<u?(i.autofit=!0,i.reduce=f):(i.autofit=!1,i.reduce=u)}return i};GnuBook.prototype.jumpToPage=function(n){var t=this.getPageIndex(n),i;return"undefined"!=typeof t?(i=0,this.jumpToIndex(t),$("#GBcontainer").attr("scrollTop",i),!0):!1};GnuBook.prototype.jumpToIndex=function(n){if(2==this.mode)this.autoStop(),n<Math.min(this.twoPage.currentIndexL,this.twoPage.currentIndexR)?this.flipBackToIndex(n):n>Math.max(this.twoPage.currentIndexL,this.twoPage.currentIndexR)&&this.flipFwdToIndex(n);else{for(var i=0,r,t=0;t<n;t++)r=parseInt(this.getPageHeight(t)/this.reduce),i+=r+this.padding;$("#GBcontainer").animate({scrollTop:i},"fast")}};GnuBook.prototype.switchMode=function(n){n!=this.mode&&this.canSwitchToMode(n)&&(this.autoStop(),this.removeSearchHilites(),this.mode=n,this.switchToolbarMode(n),1==n?(this.reduce=this.quantizeReduce(this.reduce),this.prepareOnePageView()):(this.twoPage.autofit=!1,this.reduce=this.quantizeReduce(this.reduce),this.prepareTwoPageView(),this.twoPageCenterView(.5,.5)))};GnuBook.prototype.prepareOnePageView=function(){var t=this.currentIndex(),n;$("#GBcontainer").empty();$("#GBcontainer").css({overflowY:"scroll",overflowX:"auto"});n=$("#GBcontainer").append("<div id='GBpageview'><\/div>");this.resizePageView();this.jumpToIndex(t);this.displayedIndices=[];this.drawLeafsOnePage();n.bind("mousedown",function(){return!1});n[0].onselectstart=function(){return!1}};GnuBook.prototype.prepareTwoPageView=function(n,t){var i,r,u;$("#GBcontainer").empty();$("#GBcontainer").css("overflow","auto");i=this.firstIndex;i<this.firstDisplayableIndex()&&(i=this.firstDisplayableIndex());i>this.lastDisplayableIndex()&&(i=this.lastDisplayableIndex());r=this.getSpreadIndices(i);this.twoPage.currentIndexL=r[0];this.twoPage.currentIndexR=r[1];this.firstIndex=this.twoPage.currentIndexL;this.calculateSpreadSize();this.pruneUnusedImgs();this.prefetch();$("#GBcontainer").append('<div id="GBtwopageview"><\/div>');$("#GBtwopageview").css({height:this.twoPage.totalHeight+"px",width:this.twoPage.totalWidth+"px",position:"absolute"});this.twoPage.totalWidth<$("#GBcontainer").attr("clientWidth")&&(n=.5);this.twoPage.totalHeight<$("#GBcontainer").attr("clientHeight")&&(t=.5);this.twoPageCenterView(n,t);this.twoPage.coverDiv=document.createElement("div");$(this.twoPage.coverDiv).attr("id","GBbookcover").css({border:"1px solid rgb(68, 25, 17)",width:this.twoPage.bookCoverDivWidth+"px",height:this.twoPage.bookCoverDivHeight+"px",visibility:"visible",position:"absolute",backgroundColor:"#663929",left:this.twoPage.bookCoverDivLeft+"px",top:this.twoPage.bookCoverDivTop+"px",MozBorderRadiusTopleft:"7px",MozBorderRadiusTopright:"7px",MozBorderRadiusBottomright:"7px",MozBorderRadiusBottomleft:"7px"}).appendTo("#GBtwopageview");this.leafEdgeR=document.createElement("div");this.leafEdgeR.className="leafEdgeR";$(this.leafEdgeR).css({borderStyle:"solid solid solid none",borderColor:"#663929",borderWidth:"1px 1px 1px 0px",background:"#CFBA93 url("+this.imagesBaseURL+"right_edges.png) repeat scroll 0% 0%",width:this.twoPage.leafEdgeWidthR+"px",height:this.twoPage.height-1+"px",left:this.twoPage.gutter+this.twoPage.scaledWR+"px",top:this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding+"px",position:"absolute"}).appendTo("#GBtwopageview");this.leafEdgeL=document.createElement("div");this.leafEdgeL.className="leafEdgeL";$(this.leafEdgeL).css({borderStyle:"solid none solid solid",borderColor:"#663929",borderWidth:"1px 0px 1px 1px",background:"#CFBA93 url("+this.imagesBaseURL+"left_edges.png) repeat scroll 0% 0%",width:this.twoPage.leafEdgeWidthL+"px",height:this.twoPage.height-1+"px",left:this.twoPage.bookCoverDivLeft+this.twoPage.coverInternalPadding+"px",top:this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding+"px",position:"absolute"}).appendTo("#GBtwopageview");div=document.createElement("div");$(div).attr("id","GBbookspine").css({border:"1px solid rgb(68, 25, 17)",width:this.twoPage.bookSpineDivWidth+"px",height:this.twoPage.bookSpineDivHeight+"px",position:"absolute",backgroundColor:"rgb(68, 25, 17)",left:this.twoPage.bookSpineDivLeft+"px",top:this.twoPage.bookSpineDivTop+"px"}).appendTo("#GBtwopageview");u=this;this.prepareTwoPagePopUp();this.displayedIndices=[];this.drawLeafsTwoPage();this.updateSearchHilites2UP();this.updateToolbarZoom(this.reduce);this.prefetch()};GnuBook.prototype.prepareTwoPagePopUp=function(){this.twoPagePopUp=document.createElement("div");$(this.twoPagePopUp).css({border:"1px solid black",padding:"2px 6px",position:"absolute",fontFamily:"sans-serif",fontSize:"10px",color:"#FFFFFF",zIndex:"1000",backgroundColor:"#1D1D1D",opacity:1}).appendTo("#GBcontainer");$(this.twoPagePopUp).hide();$(this.leafEdgeL).add(this.leafEdgeR).bind("mouseenter",this,function(n){$(n.data.twoPagePopUp).show()});$(this.leafEdgeL).add(this.leafEdgeR).bind("mouseleave",this,function(n){$(n.data.twoPagePopUp).hide()});$(this.leafEdgeL).bind("click",this,function(n){n.data.autoStop();var t=n.data.jumpIndexForLeftEdgePageX(n.pageX);n.data.jumpToIndex(t)});$(this.leafEdgeR).bind("click",this,function(n){n.data.autoStop();var t=n.data.jumpIndexForRightEdgePageX(n.pageX);n.data.jumpToIndex(t)});$(this.leafEdgeR).bind("mousemove",this,function(n){var t=n.data.jumpIndexForRightEdgePageX(n.pageX);$(n.data.twoPagePopUp).text("View "+n.data.getPageName(t));$(n.data.twoPagePopUp).css({left:n.pageX-$("#GBcontainer").offset().left+$("#GBcontainer").scrollLeft()-100+"px",top:n.pageY-$("#GBcontainer").offset().top+$("#GBcontainer").scrollTop()+"px"})});$(this.leafEdgeL).bind("mousemove",this,function(n){var t=n.data.jumpIndexForLeftEdgePageX(n.pageX);$(n.data.twoPagePopUp).text("View "+n.data.getPageName(t));$(n.data.twoPagePopUp).css({left:n.pageX-$("#GBcontainer").offset().left+$("#GBcontainer").scrollLeft()-$(n.data.twoPagePopUp).width()+100+"px",top:n.pageY-$("#GBcontainer").offset().top+$("#GBcontainer").scrollTop()+"px"})})};GnuBook.prototype.calculateSpreadSize=function(){var n=this.twoPage.currentIndexL,i=this.twoPage.currentIndexR,t;t=this.twoPage.autofit?this.getIdealSpreadSize(n,i):this.getSpreadSizeFromReduce(n,i,this.reduce);this.twoPage.height=t.height;this.twoPage.width=t.width;this.twoPage.scaledWL=this.getPageWidth2UP(n);this.twoPage.scaledWR=this.getPageWidth2UP(i);this.twoPage.edgeWidth=t.totalLeafEdgeWidth;this.twoPage.leafEdgeWidthL=this.leafEdgeWidth(this.twoPage.currentIndexL);this.twoPage.leafEdgeWidthR=this.twoPage.edgeWidth-this.twoPage.leafEdgeWidthL;this.twoPage.bookCoverDivWidth=this.twoPage.scaledWL+this.twoPage.scaledWR+2*this.twoPage.coverInternalPadding+this.twoPage.edgeWidth;this.twoPage.bookCoverDivHeight=this.twoPage.height+2*this.twoPage.coverInternalPadding;var r=this.gutterOffsetForIndex(n),u=this.twoPage.scaledWL-r+this.twoPage.leafEdgeWidthL,f=this.twoPage.scaledWR+r+this.twoPage.leafEdgeWidthR,e=Math.max(u,f);this.twoPage.totalWidth=2*(e+this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);this.twoPage.totalHeight=this.twoPage.height+2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);this.twoPage.middle=this.twoPage.totalWidth>>1;this.twoPage.gutter=this.twoPage.middle+this.gutterOffsetForIndex(n);this.twoPage.bookCoverDivLeft=this.twoPage.gutter-this.twoPage.scaledWL-this.twoPage.leafEdgeWidthL-this.twoPage.coverInternalPadding;this.twoPage.bookCoverDivTop=this.twoPage.coverExternalPadding;this.twoPage.bookSpineDivHeight=this.twoPage.height+2*this.twoPage.coverInternalPadding;this.twoPage.bookSpineDivLeft=this.twoPage.middle-(this.twoPage.bookSpineDivWidth>>1);this.twoPage.bookSpineDivTop=this.twoPage.bookCoverDivTop;this.reduce=t.reduce};GnuBook.prototype.getIdealSpreadSize=function(n,t){var i={},e=1.5,u={height:this.getPageHeight(n),width:this.getPageWidth(n)},f={height:this.getPageHeight(t),width:this.getPageWidth(t)},o=u.height/u.width,s=f.height/f.width,r,h,c,l,a;return r=Math.abs(o-e)<Math.abs(s-e)?o:s,h=parseInt(this.numLeafs*.1),c=parseInt($("#GBcontainer").attr("clientWidth")*.1),i.totalLeafEdgeWidth=Math.min(h,c),l=2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding)+i.totalLeafEdgeWidth,a=2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding),i.width=$("#GBcontainer").width()-l>>1,i.width-=10,i.height=$("#GBcontainer").height()-a,i.height-=20,i.height/r<=i.width?i.width=parseInt(i.height/r):i.height=parseInt(i.width*r),i.reduce=(u.height+f.height)/2/i.height,i};GnuBook.prototype.getSpreadSizeFromReduce=function(n,t,i){var r={},e=parseInt(this.numLeafs*.1),o=parseInt($("#GBcontainer").attr("clientWidth")*.1),u,f;return r.totalLeafEdgeWidth=Math.min(e,o),u=this.getPageWidth(n)+this.getPageWidth(t),f=this.getPageHeight(n)+this.getPageHeight(t),r.height=parseInt(f/2/this.reduce),r.width=parseInt(u/2/this.reduce),r.reduce=i,r};GnuBook.prototype.twoPageGetAutofitReduce=function(){var n=this.getIdealSpreadSize(this.twoPage.currentIndexL,this.twoPage.currentIndexR);return n.reduce};GnuBook.prototype.twoPageSetCursor=function(){$("#GBtwopageview").width()>$("#GBcontainer").attr("clientWidth")||$("#GBtwopageview").height()>$("#GBcontainer").attr("clientHeight")?($(this.prefetchedImgs[this.twoPage.currentIndexL]).css("cursor","move"),$(this.prefetchedImgs[this.twoPage.currentIndexR]).css("cursor","move")):($(this.prefetchedImgs[this.twoPage.currentIndexL]).css("cursor",""),$(this.prefetchedImgs[this.twoPage.currentIndexR]).css("cursor",""))};GnuBook.prototype.currentIndex=function(){if(this.mode==this.constMode1up||this.mode==this.constMode2up)return this.firstIndex;throw"currentIndex called for unimplemented mode "+this.mode;};GnuBook.prototype.right=function(){"rl"!=this.pageProgression?gb.next():gb.prev()};GnuBook.prototype.rightmost=function(){"rl"!=this.pageProgression?gb.last():gb.first()};GnuBook.prototype.left=function(){"rl"!=this.pageProgression?gb.prev():gb.next()};GnuBook.prototype.leftmost=function(){"rl"!=this.pageProgression?gb.first():gb.last()};GnuBook.prototype.next=function(){2==this.mode?(this.autoStop(),this.flipFwdToIndex(null)):this.firstIndex<this.lastDisplayableIndex()&&this.jumpToIndex(this.firstIndex+1)};GnuBook.prototype.prev=function(){2==this.mode?(this.autoStop(),this.flipBackToIndex(null)):this.firstIndex>=1&&this.jumpToIndex(this.firstIndex-1)};GnuBook.prototype.first=function(){2==this.mode?this.jumpToIndex(2):this.jumpToIndex(0)};GnuBook.prototype.last=function(){2==this.mode?this.jumpToIndex(this.lastDisplayableIndex()):this.jumpToIndex(this.lastDisplayableIndex())};GnuBook.prototype.flipBackToIndex=function(n){var i,t,r;if(1!=this.mode&&(i=this.twoPage.currentIndexL,!(i<=2))&&!this.animating){if(null!=this.leafEdgeTmp){alert("error: leafEdgeTmp should be null!");return}(null==n&&(n=i-2),t=this.getSpreadIndices(n),t[0]<0||t[1]<0)||(this.animating=!0,"rl"!=this.pageProgression?(this.prepareFlipLeftToRight(t[0],t[1]),this.flipLeftToRight(t[0],t[1])):(r=this.prepareFlipRightToLeft(t[0],t[1]),this.flipRightToLeft(t[0],t[1],r)))}};GnuBook.prototype.flipLeftToRight=function(n,t){var f=this.twoPage.currentIndexL,a=this.leafEdgeWidth(this.twoPage.currentIndexL),u=this.leafEdgeWidth(n),s=a-u,h=this.getPageWidth2UP(f),o=this.getPageWidth2UP(n),e=this.getPageWidth2UP(t),v=this.twoPageTop(),r=this.twoPage.middle+this.gutterOffsetForIndex(n),y=r-h-s,c,l,i;this.leafEdgeTmp=document.createElement("div");$(this.leafEdgeTmp).css({borderStyle:"solid none solid solid",borderColor:"#663929",borderWidth:"1px 0px 1px 1px",background:"transparent url("+this.imagesBaseURL+"left_edges.png) repeat scroll 0% 0%",width:s+"px",height:this.twoPage.height-1+"px",left:y+"px",top:v+"px",position:"absolute",zIndex:1e3}).appendTo("#GBtwopageview");$(this.leafEdgeL).css({width:u+"px",left:r-h-u+"px"});c=$(this.prefetchedImgs[f]).offset().left;l=$("#GBtwopageview").attr("clientWidth")-c-$(this.prefetchedImgs[f]).width()+$("#GBtwopageview").offset().left-2+"px";$(this.prefetchedImgs[f]).css({right:l,left:""});$(this.leafEdgeTmp).animate({left:r},this.flipSpeed,"easeInSine");i=this;this.removeSearchHilites();$(this.prefetchedImgs[f]).animate({width:"0px"},i.flipSpeed,"easeInSine",function(){$(i.leafEdgeTmp).animate({left:r+e+"px"},i.flipSpeed,"easeOutSine");$(i.prefetchedImgs[t]).animate({width:e+"px"},i.flipSpeed,"easeOutSine",function(){$(i.prefetchedImgs[n]).css("zIndex",2);$(i.leafEdgeR).css({width:i.twoPage.edgeWidth-u+"px",left:r+e+"px"});$(i.leafEdgeL).css({width:u+"px",left:r-o-u+"px"});$(i.twoPage.coverDiv).css({width:i.twoPageCoverWidth(o+e)+"px",left:r-o-u-i.twoPage.coverInternalPadding+"px"});$(i.leafEdgeTmp).remove();i.leafEdgeTmp=null;i.twoPage.currentIndexL=n;i.twoPage.currentIndexR=t;i.twoPage.scaledWL=o;i.twoPage.scaledWR=e;i.twoPage.gutter=r;i.firstIndex=i.twoPage.currentIndexL;i.displayedIndices=[n,t];i.pruneUnusedImgs();i.prefetch();i.animating=!1;i.updateSearchHilites2UP();i.updatePageNumBox2UP();i.setMouseHandlers2UP();i.twoPageSetCursor();i.animationFinishedCallback&&(i.animationFinishedCallback(),i.animationFinishedCallback=null)})})};GnuBook.prototype.flipFwdToIndex=function(n){var t,i;if(!this.animating){if(null!=this.leafEdgeTmp){alert("error: leafEdgeTmp should be null!");return}(null==n&&(n=this.twoPage.currentIndexR+2),n>this.lastDisplayableIndex())||(this.animating=!0,t=this.getSpreadIndices(n),"rl"!=this.pageProgression?(i=this.prepareFlipRightToLeft(t[0],t[1]),this.flipRightToLeft(t[0],t[1],i)):(i=this.prepareFlipLeftToRight(t[0],t[1]),this.flipLeftToRight(t[0],t[1])))}};GnuBook.prototype.flipRightToLeft=function(n,t){var c=this.leafEdgeWidth(this.twoPage.currentIndexL),l=this.twoPage.edgeWidth-c,e=this.leafEdgeWidth(n),s=this.twoPage.edgeWidth-e,h=l-s,a=this.twoPageTop(),v=this.getPageWidth2UP(this.twoPage.currentIndexR),y=this.twoPage.middle,r=y+this.gutterOffsetForIndex(n),i,f;this.leafEdgeTmp=document.createElement("div");$(this.leafEdgeTmp).css({borderStyle:"solid none solid solid",borderColor:"#663929",borderWidth:"1px 0px 1px 1px",background:"transparent url("+this.imagesBaseURL+"left_edges.png) repeat scroll 0% 0%",width:h+"px",height:this.twoPage.height-1+"px",left:r+v+"px",top:a+"px",position:"absolute",zIndex:1e3}).appendTo("#GBtwopageview");var p=this.getPageWidth2UP(this.twoPage.currentIndexL),w=this.getPageWidth2UP(this.twoPage.currentIndexR),u=this.getPageWidth2UP(n),o=this.getPageWidth2UP(t);$(this.leafEdgeR).css({width:s+"px",left:r+o+"px"});i=this;f=this.flipSpeed;this.removeSearchHilites();$(this.leafEdgeTmp).animate({left:r},f,"easeInSine");$(this.prefetchedImgs[this.twoPage.currentIndexR]).animate({width:"0px"},f,"easeInSine",function(){$(i.leafEdgeTmp).animate({left:r-u-h+"px"},f,"easeOutSine");$(i.prefetchedImgs[n]).animate({width:u+"px"},f,"easeOutSine",function(){$(i.prefetchedImgs[t]).css("zIndex",2);$(i.leafEdgeL).css({width:e+"px",left:r-u-e+"px"});$(i.twoPage.coverDiv).css({width:i.twoPageCoverWidth(u+o)+"px",left:r-u-e-i.twoPage.coverInternalPadding+"px"});$(i.leafEdgeTmp).remove();i.leafEdgeTmp=null;i.twoPage.currentIndexL=n;i.twoPage.currentIndexR=t;i.twoPage.scaledWL=u;i.twoPage.scaledWR=o;i.twoPage.gutter=r;i.firstIndex=i.twoPage.currentIndexL;i.displayedIndices=[n,t];i.pruneUnusedImgs();i.prefetch();i.animating=!1;i.updateSearchHilites2UP();i.updatePageNumBox2UP();i.setMouseHandlers2UP();i.twoPageSetCursor();i.animationFinishedCallback&&(i.animationFinishedCallback(),i.animationFinishedCallback=null)})})};GnuBook.prototype.setMouseHandlers2UP=function(){this.setDragHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexL]);this.setClickHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexL],{self:this},function(n){n.data.self.left()});this.setDragHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexR]);this.setClickHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexR],{self:this},function(n){n.data.self.right()})};GnuBook.prototype.prefetchImg=function(n){var i=this.getPageURI(n),r=!1,t;undefined==this.prefetchedImgs[n]?r=!0:i!=this.prefetchedImgs[n].uri&&(r=!0);r&&(t=document.createElement("img"),t.src=i,t.uri=i,this.prefetchedImgs[n]=t)};GnuBook.prototype.prepareFlipLeftToRight=function(n,t){this.prefetchImg(n);this.prefetchImg(t);var f=this.getPageHeight(n),e=this.getPageWidth(n),o=this.twoPage.middle,i=this.twoPageTop(),r=this.twoPage.height*e/f,u=o+this.gutterOffsetForIndex(n);$(this.prefetchedImgs[n]).css({position:"absolute",left:u-r+"px",right:"",top:i+"px",backgroundColor:"rgb(234, 226, 205)",height:this.twoPage.height,width:r+"px",borderRight:"0px solid black",zIndex:1});$("#GBtwopageview").append(this.prefetchedImgs[n]);$(this.prefetchedImgs[t]).css({position:"absolute",left:u+"px",right:"",top:i+"px",backgroundColor:"rgb(234, 226, 205)",height:this.twoPage.height,width:"0px",borderLeft:"0px solid black",zIndex:2});$("#GBtwopageview").append(this.prefetchedImgs[t])};GnuBook.prototype.prepareFlipRightToLeft=function(n,t){this.prefetchImg(n);this.prefetchImg(t);var i=this.getPageHeight(t),r=this.getPageWidth(t),o=this.twoPage.middle,u=this.twoPageTop(),f=this.twoPage.height*r/i,e=o+this.gutterOffsetForIndex(n);$(this.prefetchedImgs[t]).css({position:"absolute",left:e+"px",top:u+"px",backgroundColor:"rgb(234, 226, 205)",height:this.twoPage.height,width:f+"px",borderLeft:"0px solid black",zIndex:1});$("#GBtwopageview").append(this.prefetchedImgs[t]);i=this.getPageHeight(n);r=this.getPageWidth(n);f=this.twoPage.height*r/i;$(this.prefetchedImgs[n]).css({position:"absolute",right:$("#GBtwopageview").attr("clientWidth")-e+"px",top:u+"px",backgroundColor:"rgb(234, 226, 205)",height:this.twoPage.height,width:"0px",borderRight:"0px solid black",zIndex:2});$("#GBtwopageview").append(this.prefetchedImgs[n])};GnuBook.prototype.pruneUnusedImgs=function(){for(var n in this.prefetchedImgs)n!=this.twoPage.currentIndexL&&n!=this.twoPage.currentIndexR&&$(this.prefetchedImgs[n]).remove(),(n<this.twoPage.currentIndexL-4||n>this.twoPage.currentIndexR+4)&&delete this.prefetchedImgs[n]};GnuBook.prototype.prefetch=function(){var n,i,r;this.prefetchImg(this.twoPage.currentIndexL);this.prefetchImg(this.twoPage.currentIndexR);var t=3,u=Math.min(this.twoPage.currentIndexL,this.twoPage.currentIndexR),f=Math.max(this.twoPage.currentIndexL,this.twoPage.currentIndexR),e=Math.max(u-t,0),o=Math.min(f+t,this.numLeafs-1);for(n=1;n<=t;n++)i=u-n,i>=e&&this.prefetchImg(i),r=f+n,r<=o&&this.prefetchImg(r)};GnuBook.prototype.getPageWidth2UP=function(n){var t=this.getPageHeight(n),i=this.getPageWidth(n);return Math.floor(this.twoPage.height*i/t)};GnuBook.prototype.search=function(n){$("#GnuBookSearchScript").remove();var t=document.createElement("script");t.setAttribute("id","GnuBookSearchScript");t.setAttribute("type","text/javascript");t.setAttribute("src","http://"+this.server+"/GnuBook/flipbook_search_gb.php?url="+escape(this.bookPath+"_djvu.xml")+"&term="+n+"&format=XML&callback=gb.GBSearchCallback");document.getElementsByTagName("head")[0].appendChild(t);$("#GnuBookSearchResults").html("Searching...")};GnuBook.prototype.GBSearchCallback=function(n){var c,f,s,e,o,t,i,u,l;jQuery.browser.msie?(f=new ActiveXObject("Microsoft.XMLDOM"),f.async="false",f.loadXML(n)):(c=new DOMParser,f=c.parseFromString(n,"text/xml"));$("#GnuBookSearchResults").empty();$("#GnuBookSearchResults").append("<ul>");for(s in this.searchResults)null!=this.searchResults[s].div&&$(this.searchResults[s].div).remove(),delete this.searchResults[s];if(e=f.getElementsByTagName("PAGE"),0==e.length)$("#GnuBookSearchResults").append("<li>No search results found<\/li>");else for(o=0;o<e.length;o++){var a=new RegExp(/_(\d{4})/),v=a.exec(e[o].getAttribute("file")),i=parseInt(v[1],10),r=e[o].childNodes,h="";for(t=0;t<r.length;t++)"CONTEXT"==r[t].nodeName?h+=r[t].firstChild.nodeValue:"WORD"==r[t].nodeName&&(h+="<b>"+r[t].firstChild.nodeValue+"<\/b>",i=this.leafNumToIndex(i),null!=i&&(u=r[t].getAttribute("coords").split(",",4),4==u.length&&(this.searchResults[i]={l:u[0],b:u[1],r:u[2],t:u[3],div:null})));l=this.getPageName(i);$("#GnuBookSearchResults").append('<li><b><a href="javascript:gb.jumpToIndex('+i+');">'+l+"<\/a><\/b> - "+h+"<\/li>")}$("#GnuBookSearchResults").append("<\/ul>");this.updateSearchHilites()};GnuBook.prototype.updateSearchHilites=function(){2==this.mode?this.updateSearchHilites2UP():this.updateSearchHilites1UP()};GnuBook.prototype.updateSearchHilites1UP=function(){var t,n;for(t in this.searchResults)-1!=jQuery.inArray(parseInt(t),this.displayedIndices)?(n=this.searchResults[t],null==n.div&&(n.div=document.createElement("div"),$(n.div).attr("className","GnuBookSearchHilite").appendTo("#pagediv"+t)),$(n.div).css({width:(n.r-n.l)/this.reduce+"px",height:(n.b-n.t)/this.reduce+"px",left:n.l/this.reduce+"px",top:n.t/this.reduce+"px"})):this.searchResults[t].div=null};GnuBook.prototype.twoPageGutter=function(){return this.twoPage.middle+this.gutterOffsetForIndex(this.twoPage.currentIndexL)};GnuBook.prototype.twoPageTop=function(){return this.twoPage.coverExternalPadding+this.twoPage.coverInternalPadding};GnuBook.prototype.twoPageCoverWidth=function(n){return n+this.twoPage.edgeWidth+2*this.twoPage.coverInternalPadding};GnuBook.prototype.twoPageGetViewCenter=function(){var n={},t=$("#GBcontainer").offset(),i=$("#GBtwopageview").offset();return n.percentageX=(t.left-i.left+($("#GBcontainer").attr("clientWidth")>>1))/this.twoPage.totalWidth,n.percentageY=(t.top-i.top+($("#GBcontainer").attr("clientHeight")>>1))/this.twoPage.totalHeight,n};GnuBook.prototype.twoPageCenterView=function(n,t){"undefined"==typeof n&&(n=.5);"undefined"==typeof t&&(t=.5);var u=$("#GBtwopageview").width(),i=$("#GBcontainer").attr("clientWidth"),f=n*u,e=$("#GBtwopageview").height(),r=$("#GBcontainer").attr("clientHeight"),o=t*e;u<i?$("#GBtwopageview").css("left",(i>>1)-f+"px"):($("#GBtwopageview").css("left",0),$("#GBcontainer").scrollLeft(f-(i>>1)));e<r?$("#GBtwopageview").css("top",(r>>1)-o+"px"):($("#GBtwopageview").css("top",0),$("#GBcontainer").scrollTop(o-(r>>1)))};GnuBook.prototype.twoPageFlipAreaHeight=function(){return parseInt(this.twoPage.height)};GnuBook.prototype.twoPageFlipAreaWidth=function(){var n=this.twoPage.width*.15;return parseInt(GnuBook.util.clamp(n,10,100))};GnuBook.prototype.twoPageFlipAreaTop=function(){return parseInt(this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding)};GnuBook.prototype.twoPageLeftFlipAreaLeft=function(){return parseInt(this.twoPage.gutter-this.twoPage.scaledWL)};GnuBook.prototype.twoPageRightFlipAreaLeft=function(){return parseInt(this.twoPage.gutter+this.twoPage.scaledWR-this.twoPageFlipAreaWidth())};GnuBook.prototype.twoPagePlaceFlipAreas=function(){$(this.twoPage.leftFlipArea).css({left:this.twoPageLeftFlipAreaLeft()+"px",width:this.twoPageFlipAreaWidth()+"px"});$(this.twoPage.rightFlipArea).css({left:this.twoPageRightFlipAreaLeft()+"px",width:this.twoPageFlipAreaWidth()+"px"})};GnuBook.prototype.updateSearchHilites2UP=function(){var n,t,f;for(n in this.searchResults)if(n=parseInt(n,10),-1!=jQuery.inArray(n,this.displayedIndices)){t=this.searchResults[n];null==t.div&&(t.div=document.createElement("div"),$(t.div).attr("className","GnuBookSearchHilite").css("zIndex",3).appendTo("#GBtwopageview"));var e=this.getPageHeight(n),o=this.getPageWidth(n),i=this.twoPage.height/e,s=parseInt(o*i),r=this.twoPageGutter(),u;u="L"==this.getPageSide(n)?r-s:r;f=this.twoPageTop();$(t.div).css({width:(t.r-t.l)*i+"px",height:(t.b-t.t)*i+"px",left:u+t.l*i+"px",top:f+t.t*i+"px"})}else null!=this.searchResults[n].div&&$(this.searchResults[n].div).remove(),this.searchResults[n].div=null};GnuBook.prototype.removeSearchHilites=function(){for(var n in this.searchResults)null!=this.searchResults[n].div&&($(this.searchResults[n].div).remove(),this.searchResults[n].div=null)};GnuBook.prototype.showEmbedCode=function(){null==this.embedPopup&&(this.autoStop(),this.embedPopup=document.createElement("div"),$(this.embedPopup).css({position:"absolute",top:"20px",left:($("#GBcontainer").attr("clientWidth")-400)/2+"px",width:"400px",padding:"20px",border:"3px double #999999",zIndex:3,backgroundColor:"#fff"}).appendTo("#GnuBook"),htmlStr='<p style="text-align:center;"><b>Embed Bookreader in your blog!<\/b><\/p>',htmlStr+="<p>The bookreader uses iframes for embedding. It will not work on web hosts that block iframes. The embed feature has been tested on blogspot.com blogs as well as self-hosted Wordpress blogs. This feature will NOT work on wordpress.com blogs.<\/p>",htmlStr+='<p>Embed Code: <input type="text" size="40" value="'+this.getEmbedCode()+'"><\/p>',htmlStr+='<p style="text-align:center;"><a href="" onclick="gb.embedPopup = null; $(this.parentNode.parentNode).remove(); return false">Close popup<\/a><\/p>',this.embedPopup.innerHTML=htmlStr,$(this.embedPopup).find("input").bind("click",function(){this.select()}))};GnuBook.prototype.autoToggle=function(){var t=!1,n;2!=this.mode&&(t=!0,this.switchMode(2));this.reduce<this.twoPageGetAutofitReduce()&&this.zoom2up(0);n=this;null==this.autoTimer?(this.flipSpeed=2e3,"rl"==this.pageProgression&&t||this.flipFwdToIndex(),$("#GBtoolbar .play").hide(),$("#GBtoolbar .pause").show(),this.autoTimer=setInterval(function(){n.animating||(Math.max(n.twoPage.currentIndexL,n.twoPage.currentIndexR)>=n.lastDisplayableIndex()?n.flipBackToIndex(1):n.flipFwdToIndex())},5e3)):this.autoStop()};GnuBook.prototype.autoStop=function(){null!=this.autoTimer&&(clearInterval(this.autoTimer),this.flipSpeed="fast",$("#GBtoolbar .pause").hide(),$("#GBtoolbar .play").show(),this.autoTimer=null)};GnuBook.prototype.stopFlipAnimations=function(){this.autoStop();this.leafEdgeTmp&&$(this.leafEdgeTmp).stop(!1,!0);jQuery.each(this.prefetchedImgs,function(){$(this).stop(!1,!0)});this.leafEdgeTmp&&$(this.leafEdgeTmp).stop(!1,!0);jQuery.each(this.prefetchedImgs,function(){$(this).stop(!1,!0)})};GnuBook.prototype.keyboardNavigationIsDisabled=function(n){return n.target.tagName=="INPUT"?!0:!1};GnuBook.prototype.gutterOffsetForIndex=function(n){var t=parseInt((n/this.numLeafs-.5)*this.twoPage.edgeWidth);return"rl"==this.pageProgression&&(t=-t),t};GnuBook.prototype.leafEdgeWidth=function(n){return this.getPageSide(n)=="L"&&this.pageProgression!="rl"?parseInt(n/this.numLeafs*this.twoPage.edgeWidth+.5):parseInt((1-n/this.numLeafs)*this.twoPage.edgeWidth+.5)};GnuBook.prototype.jumpIndexForLeftEdgePageX=function(n){var t;return"rl"!=this.pageProgression?(t=this.twoPage.currentIndexL-($(this.leafEdgeL).offset().left+$(this.leafEdgeL).width()-n)*10,GnuBook.util.clamp(Math.round(t),this.firstDisplayableIndex(),this.twoPage.currentIndexL-2)):(t=this.twoPage.currentIndexL+($(this.leafEdgeL).offset().left+$(this.leafEdgeL).width()-n)*10,GnuBook.util.clamp(Math.round(t),this.twoPage.currentIndexL+2,this.lastDisplayableIndex()))};GnuBook.prototype.jumpIndexForRightEdgePageX=function(n){var t;return"rl"!=this.pageProgression?(t=this.twoPage.currentIndexR+(n-$(this.leafEdgeR).offset().left)*10,GnuBook.util.clamp(Math.round(t),this.twoPage.currentIndexR+2,this.lastDisplayableIndex())):(t=this.twoPage.currentIndexR-(n-$(this.leafEdgeR).offset().left)*10,GnuBook.util.clamp(Math.round(t),this.firstDisplayableIndex(),this.twoPage.currentIndexR-2))};GnuBook.prototype.initToolbar=function(n){var i,t,r;$("#GnuBook").append("<div id='GBheader'><span class='bookturner_logo_top_left'><a class='GBicon top_left_logo' href='"+this.bookUrl+"'>&nbsp;<\/a><\/span><span class='GBtitle'>"+this.shortTitle(200)+"<\/span><span class='bookturner_logo_top_right'><a class='GBicon top_right_logo' href='"+this.bookUrl+"'>&nbsp;<\/a><\/span><\/div><div id='GBtoolbar'><div id='GBtoolbarLink'><a class='GBicon rollover book_link' href='"+this.bookUrl+"'>&nbsp;<\/a><\/div><div id='GBtoolbarLink2'><span class='label' style='margin-left:10px;'>ZOOM <\/span><button class='GBicon rollover zoom_out' onclick='gb.zoom(-1); return false;'/><button class='GBicon rollover zoom_in' onclick='gb.zoom(1); return false;'/><span class='label'> <span id='GBzoom'>"+parseInt(100/this.reduce)+"<\/span><\/span><\/div><\/div>");i=$("#GBtoolbar");jQuery.browser.msie&&jQuery.browser.version.substring(0,1)<"7"?i.append("<div id='GBtoolbarbuttons'>&nbsp; <\/div>"):i.append("<div id='GBtoolbarbuttons'><div class='GBtoolbarmode2' style='display: inline'><button class='GBicon rollover book_leftmost' /><button class='GBicon rollover book_left' /><form class='GBpageform' action='javascript:' onsubmit='gb.jumpToPage(this.elements[0].value)'> <span class='label'>PAGE <input id='GBpagenum' type='text' size='2' onfocus='gb.autoStop();'><\/input><\/span><\/form> of "+this.lastDisplayableIndex()+" &nbsp; &nbsp; &nbsp; <button class='GBicon rollover book_right' /><button class='GBicon rollover book_rightmost' /><\/div><div class='GBtoolbarmode1' style='display: hidden'><button class='GBicon rollover book_top' /><button class='GBicon rollover book_up' /> <button class='GBicon rollover book_down' /><button class='GBicon rollover book_bottom' /><\/div><\/div>");this.bindToolbarNavHandlers(i);t={".logo":"Go to Archive.org",".zoom_in":"Zoom in",".zoom_out":"Zoom out",".one_page_mode":"One-page view",".cover_mode":"View Cover",".two_page_mode":"Two-page view",".book_left":"Flip left",".book_right":"Flip right",".book_up":"Page up",".book_down":"Page down",".book_top":"First page",".book_bottom":"Last page"};"rl"==this.pageProgression?(t[".book_leftmost"]="Last page",t[".book_rightmost"]="First page"):(t[".book_leftmost"]="First page",t[".book_rightmost"]="Last page");for(r in t)i.find(r).attr("title",t[r]);this.canSwitchToMode(this.constMode2up)||i.find(".one_page_mode, .two_page_mode, .play, .pause").hide();jQuery.browser.msie&&jQuery.browser.version.substring(0,1)<"7"&&(this.mode=1);this.switchToolbarMode(n)};GnuBook.prototype.switchToolbarMode=function(n){1==n?($("#GBtoolbar .GBtoolbarmode2").hide(),$("#GBtoolbar .GBtoolbarmode1").show().css("display","inline")):($("#GBtoolbar .GBtoolbarmode1").hide(),$("#GBtoolbar .GBtoolbarmode2").show().css("display","inline"))};GnuBook.prototype.bindToolbarNavHandlers=function(n){n.find(".book_left").bind("click",function(){return gb.left(),!1});n.find(".book_right").bind("click",function(){return gb.right(),!1});n.find(".book_up").bind("click",function(){return gb.prev(),!1});n.find(".book_down").bind("click",function(){return gb.next(),!1});n.find(".embed").bind("click",function(){return gb.showEmbedCode(),!1});n.find(".play").bind("click",function(){return gb.autoToggle(),!1});n.find(".pause").bind("click",function(){return gb.autoToggle(),!1});n.find(".book_top").bind("click",function(){return gb.first(),!1});n.find(".book_bottom").bind("click",function(){return gb.last(),!1});n.find(".book_leftmost").bind("click",function(){return gb.leftmost(),!1});n.find(".book_rightmost").bind("click",function(){return gb.rightmost(),!1})};GnuBook.prototype.updateToolbarZoom=function(n){var t;this.constMode2up==this.mode&&this.twoPage.autofit?t="Auto":(t=(100/n).toFixed(2),t=t.replace(/0+$/,""),t=t.replace(/\.$/,"")+"%");$("#GBzoom").text(t)};GnuBook.prototype.firstDisplayableIndex=function(){return this.mode==0?0:1};GnuBook.prototype.lastDisplayableIndex=function(){var n,t;if(this.mode==2){if(this.lastDisplayableIndex2up===null){for(n=this.numLeafs-1;n>=0;n--)if(t=this.getSpreadIndices(n),Math.max(t[0],t[1])<this.numLeafs-1)break;this.lastDisplayableIndex2up=n}return this.lastDisplayableIndex2up}return this.numLeafs-1};GnuBook.prototype.shortTitle=function(n){if(this.bookTitle.length<n)return this.bookTitle;var t=this.bookTitle.substr(0,n-3);return t+"..."};GnuBook.prototype.updateFromParams=function(n){"undefined"!=typeof n.mode&&this.switchMode(n.mode);"undefined"!=typeof n.index?n.index!=this.currentIndex()&&this.jumpToIndex(n.index):"undefined"!=typeof n.page&&n.page!=this.getPageNum(this.currentIndex())&&this.jumpToPage(n.page)};GnuBook.prototype.paramsFromFragment=function(n){var t={},f,u,i,r;if(n.substr(0,1)=="#"&&(n=n.substr(1)),f=parseInt(/^\d+$/.exec(n)),!isNaN(f))return t.index=f,t;for(u=n.split("/"),i={},r=0;r<u.length;r+=2)i[u[r]]=u[r+1];return"1up"==i.mode?t.mode=this.constMode1up:"2up"==i.mode&&(t.mode=this.constMode2up),"undefined"!=typeof i.page&&(t.page=i.page),t};GnuBook.prototype.paramsFromCurrent=function(){var n={},t=this.getPageNum(this.currentIndex());return(t===0||t)&&(n.page=t),n.index=this.currentIndex(),n.mode=this.mode,n};GnuBook.prototype.fragmentFromParams=function(n){var t=[];return"undefined"!=typeof n.page?t.push("page",n.page):t.push("page","n"+n.index),t.join("/")};GnuBook.prototype.getPageIndex=function(n){var t=this.getPageIndices(n);return t.length>0?t[t.length-1]:undefined};GnuBook.prototype.getPageIndices=function(n){var i=[],r,u,t;if(n.slice(0,1)=="n")try{return r=n.slice(1,n.length),u=parseInt(r),i.append(u),i}catch(f){}for(t=0;t<this.numLeafs;t++)this.getPageNum(t)==n&&i.push(t);return i};GnuBook.prototype.getPageName=function(n){return"Page "+this.getPageNum(n)};GnuBook.prototype.updateLocationHash=function(){var n="#"+this.fragmentFromParams(this.paramsFromCurrent());window.location.replace(n);this.oldLocationHash=n};GnuBook.prototype.startLocationPolling=function(){var n=this;n.oldLocationHash=window.location.hash;this.locationPollId&&(clearInterval(this.locationPollID),this.locationPollId=null);this.locationPollId=setInterval(function(){var t=window.location.hash;t!=n.oldLocationHash&&t!=n.oldUserHash&&(n.animating?(n.autoStop(),n.animationFinishedCallback=function(){n.updateFromParams(n.paramsFromFragment(t))}):n.updateFromParams(n.paramsFromFragment(t)),n.oldUserHash=t)},500)};GnuBook.prototype.getEmbedURL=function(){return"http://"+window.location.host+"/stream/"+this.bookId+"?ui=embed"};GnuBook.prototype.getEmbedCode=function(){return"<iframe src='"+this.getEmbedURL()+"' width='480px' height='430px'><\/iframe>"};GnuBook.prototype.canSwitchToMode=function(n){return n==this.constMode2up&&this.numLeafs<6?!1:!0};GnuBook.util={clamp:function(n,t,i){return Math.min(Math.max(n,t),i)}}